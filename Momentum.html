<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Momentum, Impulse, and Collisionsï¼ˆå‹•é‡ã€è¡é‡ã€ç¢°æ’ï¼‰</title>

<!-- ===== Theme & Base ===== -->
<style>
:root{
  /* Dark (default) */
  --bg:#0b1020; --panel:#101634; --card:#131a38;
  --muted:#9fb0d0; --text:#eaf0ff; --border:rgba(255,255,255,.12);
  --brand:#6ee7ff; --brand-2:#a78bfa; --accent:#34d399; --danger:#f87171; --yellow:#fde047;
  --shadow:0 12px 32px rgba(0,0,0,.35); --radius:16px;
}
:root.light{
  /* Light */
  --bg:#f7fafc; --panel:#ffffff; --card:#ffffff;
  --muted:#566076; --text:#0b1020; --border:rgba(0,0,0,.12);
  --brand:#06b6d4; --brand-2:#8b5cf6; --accent:#10b981; --danger:#ef4444; --yellow:#eab308;
  --shadow:0 10px 24px rgba(0,0,0,.08);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  font-family: ui-sans-serif, system-ui, "Segoe UI", Roboto, Arial, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei";
  background:
    radial-gradient(1200px 600px at 10% -10%, color-mix(in oklab, var(--brand-2) 22%, transparent), transparent 60%),
    radial-gradient(900px 550px at 100% 0%, color-mix(in oklab, var(--brand) 15%, transparent), transparent 60%),
    var(--bg);
}

/* ===== Layout ===== */
.container{max-width:1080px;margin:0 auto;padding:28px 16px}
.card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)}
.stack{display:grid; gap:16px}

/* ===== Header ===== */
.header{
  display:flex; align-items:center; justify-content:space-between; gap:14px;
  padding:16px 18px;
  background:linear-gradient(135deg, color-mix(in oklab, var(--brand) 18%, transparent), color-mix(in oklab, var(--brand-2) 22%, transparent));
}
h1{margin:0;font-size:26px;letter-spacing:.2px}
.sub{color:var(--muted); font-size:14px; margin-top:6px}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.badge{background:color-mix(in oklab, var(--card) 60%, transparent); border:1px solid var(--border); color:var(--text); padding:4px 10px; border-radius:999px; font-size:12px; backdrop-filter: blur(4px)}
.header-right{display:flex; gap:8px; align-items:center}
button{
  height:36px; padding:0 14px; border-radius:10px; border:1px solid var(--border);
  background:var(--panel); color:var(--text); cursor:pointer; transition:.15s transform, .15s filter;
}
button:hover{transform:translateY(-1px); filter:brightness(1.06)}
button.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#041d26; border-color:transparent}
button.ghost{background:transparent}

/* ===== Controls ===== */
.controls{display:grid; grid-template-columns:repeat(2,minmax(260px,1fr)); gap:12px; padding:14px}
.group{border:1px dashed var(--border); border-radius:12px; padding:10px}
.group h3{margin:0 0 8px; font-size:15px; color:color-mix(in oklab, var(--text) 86%, transparent)}
.row{display:flex; gap:10px; align-items:center; padding:6px 0; flex-wrap:wrap}
label{min-width:116px; color:var(--muted); font-size:14px}
.value{width:74px; text-align:right; font-variant-numeric:tabular-nums}
input[type=range]{width:100%}
select{
  height:36px; width:100%;
  border-radius:10px; border:1px solid var(--border);
  background:color-mix(in oklab, var(--panel) 90%, var(--bg));
  color:var(--text); padding:0 10px;
}

/* ===== Main grid (Sim + Readout) ===== */
.grid2{display:grid; grid-template-columns:1.15fr .85fr; gap:14px; padding:12px}
.sim{padding:12px}
canvas{width:100%; height:300px; border:1px dashed var(--border); border-radius:12px; background:rgba(255,255,255,.03)}
:root.light canvas{background:#f7fafc}
.readout{padding:12px}
.kpi{
  display:grid; grid-template-columns:1fr 1fr; gap:14px 16px; align-items:center;
  font-variant-numeric:tabular-nums;
}
.kpi .item{display:flex; flex-direction:column}
.kpi .label{font-size:13.5px; color:color-mix(in oklab, var(--text) 70%, transparent)}
.kpi .value{font-size:20px; font-weight:800}
.divider{height:1px; background:var(--border); grid-column:1/-1}
.callout{border-left:4px solid var(--accent); background:color-mix(in oklab, var(--accent) 18%, transparent); padding:10px 12px; border-radius:10px; margin-top:8px; font-size:14px}

/* ===== Tabs ===== */
.tabs{padding:12px}
.tab-list{display:flex; gap:8px; flex-wrap:wrap}
.tab-list button{
  background:transparent; border:1px solid var(--border); color:var(--muted);
  border-radius:10px; padding:8px 14px; font-size:15px; transition:.15s
}
.tab-list button[aria-selected="true"]{
  background:linear-gradient(135deg, color-mix(in oklab, var(--brand) 25%, transparent), color-mix(in oklab, var(--brand-2) 25%, transparent));
  color:var(--text); box-shadow:0 0 12px color-mix(in oklab, var(--brand) 35%, transparent)
}
.tab-panel{display:none; margin-top:10px; font-size:17px; line-height:1.8}
.tab-panel.active{display:block; animation:fade .2s ease}
@keyframes fade {from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none}}
.formula-block{text-align:center;font-size:19px;background:color-mix(in oklab, var(--card) 70%, transparent);border:1px dashed var(--border);border-radius:10px;margin:10px 0;padding:10px}
#panel-quiz ol li{background:color-mix(in oklab, var(--card) 60%, transparent); border-left:4px solid var(--brand-2); padding:8px 12px; border-radius:8px; margin-bottom:10px; font-size:17px; font-weight:500}

/* ===== Footer & Responsive ===== */
.footer{color:var(--muted); font-size:12px; text-align:center; padding:16px}
@media (max-width: 960px){ .grid2{grid-template-columns:1fr} canvas{height:260px} }
</style>

<!-- MathJax -->
<script>window.MathJax={tex:{inlineMath:[['\\(','\\)'],['$','$']]}};</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>
<div class="container stack">

  <!-- ===== Header ===== -->
  <section class="card header" aria-label="é é¦–">
    <div>
      <h1>Momentum, Impulse, and Collisionsï¼ˆå‹•é‡ã€è¡é‡ã€ç¢°æ’ï¼‰</h1>
      <p class="sub">æŒæ¡å‹•é‡å®ˆæ†èˆ‡ä¸åŒç¢°æ’é¡å‹ã€‚</p>
      <div class="badges">
        <span class="badge">å‹•é‡å®ˆæ†</span>
        <span class="badge">è¡é‡ \(J=\Delta p\)</span>
        <span class="badge">æ¢å¾©ä¿‚æ•¸ \(e\)</span>
      </div>
    </div>
    <div class="header-right">
      <button id="themeBtn" class="ghost" aria-label="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“ ä¸»é¡Œ</button>
    </div>
  </section>

  <!-- ===== Controls ===== -->
  <section class="card controls" aria-label="æ§åˆ¶é¢æ¿">
    <div class="group">
      <h3>æ¨¡æ“¬æ§åˆ¶</h3>
      <div class="row" style="gap:8px">
        <button id="start" class="primary">â–¶ï¸ é–‹å§‹</button>
        <button id="pause">â¸ æš«åœ</button>
        <button id="reset">â†º é‡è¨­</button>
      </div>
      <div class="row">
        <label for="mode">ç¢°æ’é¡å‹</label>
        <select id="mode" aria-label="ç¢°æ’é¡å‹é¸æ“‡">
          <option value="elastic">å½ˆæ€§ (e = 1)</option>
          <option value="inelastic">å®Œå…¨éå½ˆæ€§ (e = 0)</option>
          <option value="custom">è‡ªè¨‚ e</option>
        </select>
      </div>
      <div class="row" id="eRow" style="display:none">
        <label for="e">æ¢å¾©ä¿‚æ•¸ e</label>
        <input id="e" type="range" min="0" max="1" step="0.05" value="0.60"><div id="ev" class="value">0.60</div>
      </div>
    </div>

    <div class="group">
      <h3>åƒæ•¸è¨­å®š</h3>
      <div class="row"><label for="m1">mâ‚ (kg)</label><input id="m1" type="range" min="0.5" max="5" step="0.1" value="2.7"><div id="m1v" class="value">2.70</div></div>
      <div class="row"><label for="m2">mâ‚‚ (kg)</label><input id="m2" type="range" min="0.5" max="5" step="0.1" value="2.6"><div id="m2v" class="value">2.60</div></div>
      <div class="row"><label for="v1">vâ‚ (m/s)</label><input id="v1" type="range" min="-5" max="5" step="0.1" value="2"><div id="v1v" class="value">2.00</div></div>
      <div class="row"><label for="v2">vâ‚‚ (m/s)</label><input id="v2" type="range" min="-5" max="5" step="0.1" value="-1"><div id="v2v" class="value">-1.00</div></div>
    </div>
  </section>

  <!-- ===== Simulation + Readout ===== -->
  <section class="card grid2" aria-label="æ¨¡æ“¬èˆ‡è®€å€¼">
    <div class="sim">
      <canvas id="sim" width="560" height="300" aria-label="æ¨¡æ“¬ç•«é¢"></canvas>
    </div>
    <div class="readout">
      <div class="kpi">
        <div class="item"><div class="label">ç¸½å‹•é‡ p_before</div><div><span id="pb" class="value">â€”</span> <span style="opacity:.7">kgÂ·m/s</span></div></div>
        <div class="item"><div class="label">ç¸½å‹•é‡ p_after</div><div><span id="pa" class="value">â€”</span> <span style="opacity:.7">kgÂ·m/s</span></div></div>
        <div class="item"><div class="label">Î”pï¼ˆç³»çµ±ï¼‰</div><div><span id="jp" class="value">â€”</span> <span style="opacity:.7">kgÂ·m/s</span></div></div>
        <div class="item"><div class="label">Î”Kï¼ˆå‹•èƒ½è®ŠåŒ–ï¼‰</div><div><span id="dk" class="value">â€”</span> <span style="opacity:.7">J</span></div></div>
        <div class="divider"></div>
        <div class="item"><div class="label">mâ‚ï¼šv â†’ vâ€²</div><div><span id="v1pair" class="value">â€”</span></div></div>
        <div class="item"><div class="label">mâ‚‚ï¼šv â†’ vâ€²</div><div><span id="v2pair" class="value">â€”</span></div></div>
      </div>
      <div class="callout" id="tipBox">å°æé†’ï¼šå½ˆæ€§ç¢°æ’å‹•èƒ½å®ˆæ†ï¼›éå½ˆæ€§ç¢°æ’å‹•èƒ½ä¸‹é™ï¼Œä½†ç³»çµ±å‹•é‡ä»å®ˆæ†ã€‚</div>
    </div>
  </section>

  <!-- ===== Learning Tabs ===== -->
  <section class="card tabs" aria-label="å­¸ç¿’åˆ†é ">
    <div class="tab-list" role="tablist" aria-label="å­¸ç¿’åˆ†é ">
      <button role="tab" class="tab" aria-selected="true" data-tab="law">å®šå¾‹å…§å®¹</button>
      <button role="tab" class="tab" aria-selected="false" data-tab="formula">å…¬å¼è¡¨ç¤º</button>
      <button role="tab" class="tab" aria-selected="false" data-tab="diagram">åœ–åƒç†è§£</button>
      <button role="tab" class="tab" aria-selected="false" data-tab="scope">é©ç”¨ç¯„åœ</button>
      <button role="tab" class="tab" aria-selected="false" data-tab="apps">å¸¸è¦‹æ‡‰ç”¨</button>
      <button role="tab" class="tab" aria-selected="false" data-tab="quiz">æ•™å­¸å»¶ä¼¸å•é¡Œ</button>
      <button role="tab" class="tab" aria-selected="false" data-tab="ans">å»¶ä¼¸å•é¡Œè§£ç­”</button>
    </div>

    <div id="panel-law" class="tab-panel active">
      <ul>
        <li><b>å‹•é‡ï¼ˆMomentumï¼‰</b>ï¼š\( \vec p=m\vec v \)ï¼Œæ–¹å‘åŒé€Ÿåº¦ã€‚</li>
        <li><b>è¡é‡ï¼ˆImpulseï¼‰</b>ï¼š\( \vec J=\int \vec F\,dt=\Delta\vec p \)ã€‚</li>
        <li><b>å‹•é‡å®ˆæ†</b>ï¼šå­¤ç«‹ç³»çµ±ï¼ˆå¤–åŠ›åˆâ‰ˆ0ï¼‰ç¸½å‹•é‡ä¸è®Šã€‚</li>
        <li><b>ç¢°æ’å‹æ…‹</b>ï¼šå½ˆæ€§ï¼ˆå‹•é‡/å‹•èƒ½å®ˆæ†ï¼‰ã€å®Œå…¨éå½ˆæ€§ï¼ˆç¢°å¾ŒåŒé€Ÿï¼Œåƒ…å‹•é‡å®ˆæ†ï¼‰ã€ä¸€èˆ¬éå½ˆæ€§ï¼ˆæ¢å¾©ä¿‚æ•¸ \(e\) ä»‹æ–¼ 0â€“1ï¼‰ã€‚</li>
      </ul>
    </div>

    <div id="panel-formula" class="tab-panel">
      <div class="formula-block">å‹•é‡ï¼š\( \displaystyle \vec p = m\vec v \)</div>
      <div class="formula-block">è¡é‡ï¼š\( \displaystyle \vec J = \int \vec F\, dt = \Delta \vec p \)</div>
      <div class="formula-block">å‹•é‡å®ˆæ†ï¼š\( \displaystyle \sum \vec p_i = \sum \vec p_f \)</div>
      <div class="formula-block">å½ˆæ€§ç¢°æ’ï¼ˆ1Dï¼‰ï¼š\( \displaystyle v_1'=\frac{(m_1-m_2)v_1+2m_2v_2}{m_1+m_2}, \;
        v_2'=\frac{(m_2-m_1)v_2+2m_1v_1}{m_1+m_2} \)</div>
      <div class="formula-block">ä¸€èˆ¬éå½ˆæ€§ï¼ˆ1Dï¼Œæ¢å¾©ä¿‚æ•¸ \(e\)ï¼‰ï¼š\( \displaystyle v_1'=\frac{m_1v_1+m_2v_2-m_2 e (v_1-v_2)}{m_1+m_2},\;
        v_2'=\frac{m_1v_1+m_2v_2+m_1 e (v_1-v_2)}{m_1+m_2} \)</div>
    </div>

    <div id="panel-diagram" class="tab-panel">
      <figure style="text-align:center; margin: 6px 0 10px">
        <svg width="620" height="120" viewBox="0 0 620 120" role="img" aria-label="ä¸€ç¶­ç¢°æ’ç¤ºæ„åœ–">
          <defs>
            <marker id="arrowBlue" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto">
              <path d="M0 0 L10 5 L0 10 Z" fill="var(--brand)"></path>
            </marker>
            <marker id="arrowRed" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto">
              <path d="M0 0 L10 5 L0 10 Z" fill="var(--danger)"></path>
            </marker>
          </defs>
          <line x1="20" y1="60" x2="600" y2="60" stroke="currentColor" opacity=".35" stroke-width="2"/>
          <circle cx="170" cy="60" r="20" fill="var(--brand)"/>
          <text x="170" y="56" text-anchor="middle" font-size="12" fill="#001018">mâ‚</text>
          <line x1="210" y1="60" x2="290" y2="60" stroke="var(--brand)" stroke-width="3" marker-end="url(#arrowBlue)"/>
          <text x="250" y="50" font-size="12" fill="var(--brand)">vâ‚ &gt; 0</text>
          <circle cx="450" cy="60" r="20" fill="var(--danger)"/>
          <text x="450" y="56" text-anchor="middle" font-size="12" fill="#2b0c0c">mâ‚‚</text>
          <line x1="410" y1="60" x2="330" y2="60" stroke="var(--danger)" stroke-width="3" marker-end="url(#arrowRed)"/>
          <text x="370" y="50" font-size="12" fill="var(--danger)">vâ‚‚ &lt; 0</text>
        </svg>
        <figcaption class="sub">çŸ­æš«æ¥è§¸åŠ›æœƒé‡æ–°åˆ†é…å‹•é‡ï¼›è‹¥å¤–åŠ›å¯å¿½ç•¥ï¼Œç³»çµ±ç¸½å‹•é‡ä¸è®Šã€‚</figcaption>
      </figure>
    </div>

    <div id="panel-scope" class="tab-panel">
      <ul>
        <li>ç¢°æ’æ™‚é–“çŸ­ã€å…§åŠ›é å¤§æ–¼å¤–åŠ›ã€‚</li>
        <li>å…¥é–€ç”¨ä¸€ç¶­ï¼›å¤šç¶­éœ€åˆ†è§£æ³•å‘/åˆ‡å‘åˆ†é‡ã€‚</li>
        <li>å·¨è§€ä½é€Ÿæƒ…å¢ƒï¼›é«˜é€Ÿéœ€ç›¸å°è«–å‹•é‡ä¿®æ­£ã€‚</li>
      </ul>
    </div>

    <div id="panel-apps" class="tab-panel">
      <ul>
        <li>äº¤é€šäº‹æ•…é‡å»ºèˆ‡å¾Œåº§åŠ›ä¼°ç®—ã€‚</li>
        <li>é‹å‹•ç§‘å­¸ï¼šæ£’çƒæ‰“æ“Šã€æ’çƒåå½ˆã€è¶³çƒå°„é–€ã€‚</li>
        <li>å®‰å…¨è£ç½®ï¼šæ°£å›Š/ç·©è¡ææŠŠä½œç”¨æ™‚é–“æ‹‰é•·ï¼Œé™ä½åŠ›å³°å€¼ã€‚</li>
      </ul>
    </div>

    <div id="panel-quiz" class="tab-panel">
      <ol>
        <li>2 kg çƒä»¥ 3 m/s å‘å³ï¼Œ0.2 s å…§è¢«åœä¸‹ï¼šæ±‚è¡é‡èˆ‡å¹³å‡åŠ›ã€‚</li>
        <li>1 kg å°è»Šä»¥ 4 m/s æ’ä¸Š 3 kg éœæ­¢å°è»Šä¸¦é»ä½ï¼šåˆé«”é€Ÿåº¦èˆ‡å‹•èƒ½è®ŠåŒ–ï¼Ÿ</li>
        <li>\(m_1=1\) kgã€\(m_2=2\) kgã€\(v_1=5\) m/sã€\(v_2=0\)ï¼šå½ˆæ€§ç¢°æ’å¾Œ \(v_1',v_2'\)ï¼Ÿ</li>
        <li>åŒå‘ä¸€èˆ¬éå½ˆæ€§ï¼Œ\(v_1=6\) m/sã€\(v_2=2\) m/sã€\(e=0.6\) ï¼šè§£ \(v_1',v_2'\)ã€‚</li>
        <li>è³ªé» \(\vec v=(3,-4)\) m/s æ’æ°´å¹³ç‰†ï¼ˆå½ˆæ€§åå°„ï¼‰ï¼š\(\vec v'\)ï¼Ÿ</li>
      </ol>
    </div>

    <div id="panel-ans" class="tab-panel">
      <details open><summary><b>é¡Œ 1</b></summary>
        \(p=2\times3=6\) kgÂ·m/s å‘å³ï¼›\(\Delta p=-6\)ï¼ˆå‘å·¦ï¼‰ã€‚\(J=\Delta p=-6\) kgÂ·m/sï¼›\(\bar F=J/\Delta t=-6/0.2=-30\) Nï¼ˆå‘å·¦ï¼‰ã€‚
      </details>
      <details><summary><b>é¡Œ 2</b></summary>
        \(v'=(1\cdot4+3\cdot0)/4=1\) m/sï¼›\(\Delta K=2-8=-6\) Jã€‚
      </details>
      <details><summary><b>é¡Œ 3</b></summary>
        \(v_1'=-5/3\approx-1.67\)ã€\(v_2'=10/3\approx3.33\)ï¼ˆm/sï¼‰ã€‚
      </details>
      <details><summary><b>é¡Œ 4</b></summary>
        \(v_1'=\frac{m_1v_1+m_2v_2-m_2 e (v_1-v_2)}{m_1+m_2}\)ï¼Œ
        \(v_2'=\frac{m_1v_1+m_2v_2+m_1 e (v_1-v_2)}{m_1+m_2}\)ã€‚ä»£ \(e=0.6\) å¯å¾—æ•¸å€¼ã€‚
      </details>
      <details><summary><b>é¡Œ 5</b></summary>
        èˆ‡æ°´å¹³ç‰†ç¢°æ’ï¼š\(v_x'=v_x=3\)ã€\(v_y'=-v_y=4\)ï¼Œ\(\vec v'=(3,4)\) m/sã€‚
      </details>
    </div>
  </section>
</div>

<!-- ===== Scripts ===== -->
<script>
/* ---------- Theme toggle with persistence ---------- */
const root = document.documentElement;
const themeBtn = document.getElementById('themeBtn');
(function initTheme(){
  const saved = localStorage.getItem('theme'); // 'light' | 'dark' | null
  if(saved==='light') root.classList.add('light');
  else if(saved==='dark') root.classList.remove('light');
  else {
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
      root.classList.add('light');
    }
  }
})();
themeBtn.addEventListener('click', ()=>{
  root.classList.toggle('light');
  localStorage.setItem('theme', root.classList.contains('light') ? 'light' : 'dark');
});

/* ---------- Tabs ---------- */
const tabs = document.querySelectorAll('.tab-list .tab');
const panels = {
  law: document.getElementById('panel-law'),
  formula: document.getElementById('panel-formula'),
  diagram: document.getElementById('panel-diagram'),
  scope: document.getElementById('panel-scope'),
  apps: document.getElementById('panel-apps'),
  quiz: document.getElementById('panel-quiz'),
  ans: document.getElementById('panel-ans'),
};
tabs.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    tabs.forEach(b=>b.setAttribute('aria-selected','false'));
    btn.setAttribute('aria-selected','true');
    Object.values(panels).forEach(p=>p.classList.remove('active'));
    panels[btn.dataset.tab].classList.add('active');
  });
});

/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
const fmt = n => (Math.abs(n)<1e-3)? n.toExponential(1): n.toFixed(2);
function setText(id, val){ $(id).textContent = val; }

/* ---------- Simulation ---------- */
const sliders = ["m1","m2","v1","v2","e"].map(id => $(id));
const labels  = ["m1v","m2v","v1v","v2v","ev"].map(id => $(id));
const modeSel = $("mode");
const eRow = $("eRow");
const startBtn= $("start"), pauseBtn= $("pause"), resetBtn= $("reset");
const cvs = $("sim"), ctx = cvs.getContext("2d");
const laneL=40, laneR=cvs.width-40, y=150;

let state = {
  m1:+$("m1").value, m2:+$("m2").value,
  v1:+$("v1").value, v2:+$("v2").value,
  x1:110, x2:cvs.width-110,
  r1:18, r2:18,
  e:+$("e").value, mode:"elastic",
  running:false, raf:null
};

function syncLabels(){
  labels[0].textContent = (+$("m1").value).toFixed(2);
  labels[1].textContent = (+$("m2").value).toFixed(2);
  labels[2].textContent = (+$("v1").value).toFixed(2);
  labels[3].textContent = (+$("v2").value).toFixed(2);
  labels[4].textContent = (+$("e").value).toFixed(2);
}
sliders.forEach(s=>s.addEventListener("input",()=>{ state[s.id] = +s.value; syncLabels(); draw(); }));
modeSel.addEventListener("change", ()=>{
  state.mode = modeSel.value;
  eRow.style.display = (state.mode==="custom") ? "block" : "none";
  draw();
});

const momentum=(m,v)=>m*v;
const ke=(m,v)=>0.5*m*v*v;

function solveAfter(v1,v2,m1,m2,mode,e){
  if(mode==="elastic") e=1;
  if(mode==="inelastic") e=0;
  const sumMv = m1*v1 + m2*v2;
  const dv = v1 - v2;
  const v1p = (sumMv - m2*e*dv)/(m1+m2);
  const v2p = (sumMv + m1*e*dv)/(m1+m2);
  return [v1p, v2p];
}

function draw(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  // è»Œé“
  const railColor = getComputedStyle(document.documentElement).classList?.contains('light') ? "rgba(0,0,0,.20)" : "rgba(255,255,255,.12)";
  ctx.fillStyle = railColor; ctx.fillRect(laneL, y-2, laneR-laneL, 4);

  // çƒ
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--brand').trim()||"#6ee7ff";
  ctx.beginPath(); ctx.arc(state.x1, y, state.r1, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--danger').trim()||"#f87171";
  ctx.beginPath(); ctx.arc(state.x2, y, state.r2, 0, Math.PI*2); ctx.fill();

  // è®€æ•¸
  const pb = momentum(state.m1,state.v1)+momentum(state.m2,state.v2);
  const kb = ke(state.m1,state.v1)+ke(state.m2,state.v2);
  const [v1p,v2p]=solveAfter(state.v1,state.v2,state.m1,state.m2,state.mode,state.e);
  const pa = momentum(state.m1,v1p)+momentum(state.m2,v2p);
  const ka = ke(state.m1,v1p)+ke(state.m2,v2p);
  setText("pb", fmt(pb)); setText("pa", fmt(pa));
  setText("jp", fmt(pa-pb)); setText("dk", fmt(ka-kb));
  setText("v1pair", `${state.v1.toFixed(2)} â†’ ${v1p.toFixed(2)} (m/s)`);
  setText("v2pair", `${state.v2.toFixed(2)} â†’ ${v2p.toFixed(2)} (m/s)`);
}

function step(){
  state.x1 += state.v1;
  state.x2 += state.v2;

  // é‚Šç•Œå½ˆå›
  if(state.x1-state.r1<laneL){ state.x1=laneL+state.r1; state.v1*=-1; }
  if(state.x2+state.r2>laneR){ state.x2=laneR-state.r2; state.v2*=-1; }

  // ç¢°æ’
  if(Math.abs(state.x1 - state.x2) <= state.r1 + state.r2){
    const [v1p,v2p]=solveAfter(state.v1,state.v2,state.m1,state.m2,state.mode,state.e);
    const mid = (state.x1+state.x2)/2;
    state.x1 = mid - (state.r1+1);
    state.x2 = mid + (state.r2+1);
    state.v1 = v1p; state.v2 = v2p;
  }

  draw();
  state.raf = requestAnimationFrame(step);
}

startBtn.addEventListener("click", ()=>{
  if(state.running) return;
  state.running = true; if(!state.raf) state.raf = requestAnimationFrame(step);
});
pauseBtn.addEventListener("click", ()=>{
  if(!state.running) return;
  cancelAnimationFrame(state.raf); state.raf=null; state.running=false;
  $("tipBox").textContent = "å·²æš«åœã€‚å¯èª¿æ•´åƒæ•¸å¾Œå†é–‹å§‹ã€‚";
});
resetBtn.addEventListener("click", ()=>{
  cancelAnimationFrame(state.raf); state.raf=null; state.running=false;
  state.x1=110; state.x2=cvs.width-110;
  state.v1=+$("v1").value; state.v2=+$("v2").value;
  $("tipBox").textContent = "å·²é‡è¨­ã€‚é»ã€Œé–‹å§‹ã€å•Ÿå‹•æ¨¡æ“¬ã€‚";
  draw();
});

syncLabels(); draw();
</script>
</body>
</html>
