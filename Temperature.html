<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Temperature & Heatï½œç†±æ··åˆï¼é‡ç†±ï¼ˆç„¡ä»»å‹™ï¼‹ä¸»é¡Œåˆ‡æ›ï¼‰</title>

<style>
/* ===== Theme (Dark default) ===== */
:root{
  --bg:#0b1020; --panel:#11162f; --card:#131a38; --muted:#9fb0d0; --text:#eaf0ff;
  --border:rgba(255,255,255,.12); --brand:#6ee7ff; --brand-2:#a78bfa; --accent:#34d399; --warn:#fde047;
  --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px; --canvas-bg:rgba(255,255,255,.03)
}
:root[data-theme="light"]{
  --bg:#f6f8fb; --panel:#ffffff; --card:#ffffff; --muted:#475569; --text:#0b1020;
  --border:rgba(0,0,0,.12); --brand:#0ea5e9; --brand-2:#7c3aed; --accent:#16a34a; --warn:#b45309;
  --shadow:0 8px 24px rgba(0,0,0,.10); --canvas-bg:rgba(0,0,0,.04)
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,Arial,"Noto Sans TC";
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(167,139,250,.22), transparent 60%),
    radial-gradient(900px 550px at 100% 0%, rgba(110,231,255,.18), transparent 60%),
    var(--bg);
}
:root[data-theme="light"] body{
  background:
    radial-gradient(900px 500px at 0% -10%, rgba(14,165,233,.10), transparent 60%),
    radial-gradient(900px 500px at 100% 0%, rgba(124,58,237,.08), transparent 60%),
    var(--bg);
}

.container{max-width:1100px;margin:0 auto;padding:26px 16px}
h1{margin:0 0 6px;font-size:28px} .sub{color:var(--muted);font-size:14px}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.badge{background:rgba(255,255,255,.12);border:1px solid var(--border);padding:4px 10px;border-radius:999px;font-size:12px}
:root[data-theme="light"] .badge{background:rgba(0,0,0,.05)}

.hero{
  display:flex;justify-content:space-between;gap:16px;align-items:center;
  border:1px solid var(--border);border-radius:20px;box-shadow:var(--shadow);
  background:linear-gradient(135deg, rgba(110,231,255,.18), rgba(167,139,250,.22));padding:22px 18px
}
button{height:36px;padding:0 14px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer}
button:hover{filter:brightness(1.06)}
button.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));border-color:transparent;color:#05222b}
:root[data-theme="light"] button.primary{color:#ffffff}

.grid2{display:grid;grid-template-columns:1.05fr .95fr;gap:14px;margin-top:14px}
@media (max-width:980px){.grid2{grid-template-columns:1fr}}

.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow)}
.section-title{margin:6px 0 8px}

.controls .row{display:grid;grid-template-columns:150px 1fr 80px;gap:10px;align-items:center;margin:8px 0}
.controls .row.inline{grid-template-columns:150px auto auto auto;gap:10px}
.controls label{color:var(--muted);font-size:14px}
.controls .value{text-align:right;font-variant-numeric:tabular-nums}
select,input[type=number]{height:36px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);padding:0 10px}
input[type=range]{width:100%}

.readout{display:grid;grid-template-columns:repeat(2,1fr);gap:12px 16px;font-variant-numeric:tabular-nums}
.item .label{font-size:14px;color:var(--muted);margin-bottom:4px}
.item .value{font-size:20px;font-weight:800}
.sep{grid-column:1/-1;height:1px;background:var(--border)}
.callout{border-left:4px solid var(--accent);background:color-mix(in srgb, var(--accent) 15%, transparent);padding:10px 12px;border-radius:10px;margin:8px 0}
.warn{border-left-color:var(--warn);background:color-mix(in srgb, var(--warn) 18%, transparent)}

canvas{width:100%;height:300px;border:1px dashed var(--border);border-radius:12px;background:var(--canvas-bg)}

.tabs{margin-top:14px}
.tab-list{display:flex;gap:8px;flex-wrap:wrap}
.tab-list button{background:transparent;border:1px solid var(--border);color:var(--muted);border-radius:10px;padding:8px 14px;font-size:15px}
.tab-list button[aria-selected="true"]{background:linear-gradient(135deg, rgba(110,231,255,.25), rgba(167,139,250,.25));color:var(--text);
  box-shadow:0 0 12px rgba(110,231,255,.35)}
.tab-panel{display:none;margin-top:10px;font-size:17px;line-height:1.8}
.tab-panel.active{display:block;animation:fade .2s ease}
@keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.formula-block{text-align:center;font-size:19px;background:rgba(255,255,255,.08);border:1px dashed var(--border);border-radius:10px;margin:10px 0;padding:10px}
:root[data-theme="light"] .formula-block{background:rgba(0,0,0,.04)}

.footer{color:var(--muted);font-size:12px;text-align:center;margin-top:18px}
</style>
<script>window.MathJax={tex:{inlineMath:[['\\(','\\)'],['$','$']]}};</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
<div class="container">

  <!-- ===== Hero ===== -->
  <section class="hero">
    <div>
      <h1>Temperature & Heatï½œç†±æ··åˆï¼é‡ç†±</h1>
      <div class="sub">èƒ½é‡å®ˆæ†ï¼š\( \sum Q = 0 \)ã€‚æ”¯æ´é›™æ¶²é«”ã€é‡ç†±å™¨ç†±å®¹ã€èˆ‡ 0Â°C å†°å¡ŠèåŒ–æƒ…å¢ƒã€‚</div>
      <div class="badges"><span class="badge">Q = mcÎ”T</span><span class="badge">é‡ç†±å™¨ç†±å®¹</span><span class="badge">å†°å¡ŠèåŒ–ï¼ˆé¸ç”¨ï¼‰</span></div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="themeToggle" class="primary" type="button">ğŸŒ— ä¸»é¡Œï¼šæ·±è‰²</button>
      <button id="runSim" type="button">â–¶ï¸ æ··åˆèˆ‡ç¹ªåœ–</button>
      <button id="reset" type="button">â†º é‡è¨­</button>
    </div>
  </section>

  <!-- ===== Controls + Readout ===== -->
  <section class="grid2">
    <div class="card controls">
      <h3 class="section-title">A èˆ‡ Bï¼ˆæ¶²é«”ï¼‰</h3>

      <div class="row inline">
        <label>æè³ª Aï¼B</label>
        <select id="matA"></select>
        <select id="matB"></select>
      </div>
      <div class="row"><label>è³ªé‡ mâ‚ (kg)</label><input id="mA" type="range" min="0.05" max="3" step="0.05" value="0.50"><div class="value" id="mAv">0.50</div></div>
      <div class="row"><label>æº«åº¦ Tâ‚ (Â°C)</label><input id="tA" type="range" min="0" max="95" step="1" value="70"><div class="value" id="tAv">70</div></div>
      <div class="row"><label>è³ªé‡ m_b (kg)</label><input id="mB" type="range" min="0.05" max="3" step="0.05" value="0.80"><div class="value" id="mBv">0.80</div></div>
      <div class="row"><label>æº«åº¦ T_b (Â°C)</label><input id="tB" type="range" min="0" max="95" step="1" value="20"><div class="value" id="tBv">20</div></div>

      <h3 class="section-title">é‡ç†±å™¨èˆ‡å†°å¡Šï¼ˆé¸ç”¨ï¼‰</h3>
      <div class="row"><label>é‡ç†±å™¨ç­‰æ•ˆç†±å®¹ C_cal (J/K)</label><input id="Ccal" type="range" min="0" max="1200" step="20" value="200"><div class="value" id="Ccalv">200</div></div>
      <div class="row"><label>é‡ç†±å™¨åˆæº« T_cal (Â°C)</label><input id="Tcal" type="range" min="0" max="95" step="1" value="20"><div class="value" id="Tcalv">20</div></div>
      <div class="row"><label>å†°å¡Šè³ªé‡ m_ice (kg, 0Â°C)</label><input id="mIce" type="range" min="0" max="1.0" step="0.01" value="0.00"><div class="value" id="mIcev">0.00</div></div>

      <div class="callout warn" id="noteIce">æç¤ºï¼šå†°å¡Šè¨­å®šç‚º 0Â°Cã€‚è‹¥ç†±é‡ä¸è¶³ä»¥å…¨éƒ¨èåŒ–ï¼Œæœ€çµ‚æº«åº¦ç‚º 0Â°Cï¼Œä¸¦é¡¯ç¤ºå‰©é¤˜å†°é‡ã€‚</div>
    </div>

    <div class="card">
      <h3 class="section-title">è®€æ•¸ï¼çµæœ</h3>
      <div class="readout">
        <div class="item"><div class="label">å¹³è¡¡æº«åº¦ \(T_f\)</div><div class="value"><span id="Tf">â€”</span> Â°C</div></div>
        <div class="item"><div class="label">A é‡‹ï¼å¸ç†± \(Q_a\)</div><div class="value"><span id="Qa">â€”</span> J</div></div>
        <div class="item"><div class="label">B é‡‹ï¼å¸ç†± \(Q_b\)</div><div class="value"><span id="Qb">â€”</span> J</div></div>
        <div class="item"><div class="label">é‡ç†±å™¨ \(Q_{cal}\)</div><div class="value"><span id="Qcal">â€”</span> J</div></div>
        <div class="item"><div class="label">å†°å¡ŠèåŒ–/å‡æº« \(Q_{ice}\)</div><div class="value"><span id="Qice">â€”</span> J</div></div>
        <div class="sep"></div>
        <div class="item"><div class="label">èƒ½é‡å®ˆæ†æª¢æŸ¥ \(\sum Q\)</div><div class="value"><span id="sumQ">â€”</span> J</div></div>
        <div class="item"><div class="label">å†°å¡Šæ®˜ç•™</div><div class="value"><span id="iceLeft">â€”</span> kg</div></div>
      </div>

      <div class="callout" id="tipBox">
        æ²’æœ‰å†°å¡Šæ™‚ï¼š\( T_f=\dfrac{m_a c_a T_a + m_b c_b T_b + C_{cal} T_{cal}}{m_a c_a + m_b c_b + C_{cal}} \)ã€‚
        æœ‰å†°å¡Šæ™‚æœƒè‡ªå‹•åˆ¤æ–·ã€Œå…ˆèåŒ–æ˜¯å¦è¶³å¤ ã€ï¼Œå†æ±‚ \(T_f\)ã€‚
      </div>
    </div>
  </section>

  <!-- ===== Charts ===== -->
  <section class="card">
    <h3 class="section-title">æº«åº¦è®ŠåŒ–ï¼ˆç¤ºæ„å‹•æ…‹ï¼Œéç²¾ç¢ºç†±å‚³ï¼‰</h3>
    <canvas id="chart" width="1000" height="300"></canvas>
  </section>

  <!-- ===== Learning Tabs ===== -->
  <section class="card tabs">
    <div class="tab-list" role="tablist">
      <button class="tab" role="tab" aria-selected="true" data-tab="law">å®šå¾‹å…§å®¹</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="formula">å…¬å¼è¡¨ç¤º</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="diagram">åœ–åƒç†è§£</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="scope">é©ç”¨ç¯„åœ</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="apps">å¸¸è¦‹æ‡‰ç”¨</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="quiz">æ•™å­¸å»¶ä¼¸å•é¡Œ</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="ans">å»¶ä¼¸å•é¡Œè§£ç­”</button>
    </div>

    <div id="panel-law" class="tab-panel active">
      <ul>
        <li>ç†±é‡ï¼š\(Q=mc\Delta T\)ã€‚\(m\)ï¼šè³ªé‡ï¼ˆkgï¼‰ï¼Œ\(c\)ï¼šæ¯”ç†±ï¼ˆJ/kgÂ·Kï¼‰ï¼Œ\(\Delta T\)ï¼šæº«åº¦è®ŠåŒ–ï¼ˆK æˆ– Â°Cï¼‰ã€‚</li>
        <li>é‡ç†±ï¼ˆç†æƒ³ï¼‰ï¼šéš”ç†±è‰¯å¥½ï¼Œç„¡ç†±æï¼›æ··åˆé”å¹³è¡¡æº«åº¦ \(T_f\) å¾Œ \(\sum Q = 0\)ã€‚</li>
        <li>é‡ç†±å™¨ï¼šç”¨å–®ä¸€ç­‰æ•ˆç†±å®¹ \(C_{cal}\) è¡¨ç¤ºå…¶å¸æ”¾ç†± \(Q_{cal}=C_{cal}(T_f-T_{cal})\)ã€‚</li>
        <li>ç›¸è®Šï¼ˆå†°å¡Šï¼‰ï¼šå…ˆè¨ˆç®—æ˜¯å¦æœ‰è¶³å¤ ç†±é‡ä½¿å†°å¡Šå…¨éƒ¨èåŒ– \(Q_{melt}=m_{ice}L_f\)ï¼Œå†èˆ‡ç¸½ç†±é‡å¹³è¡¡ã€‚</li>
      </ul>
    </div>

    <div id="panel-formula" class="tab-panel">
      <div class="formula-block">
        ç„¡ç›¸è®Šï¼š\(
        T_f=\frac{m_a c_a T_a + m_b c_b T_b + C_{cal}T_{cal}}
                 {m_a c_a + m_b c_b + C_{cal}}
        \)
      </div>
      <div class="formula-block">
        æœ‰å†°å¡Šï¼ˆ0Â°Cï¼‰æ™‚ï¼šå…ˆç®—æº«ç†±ç«¯é™åˆ° 0Â°C å¯æä¾›çš„ç†±é‡ \(Q_{warm\to0}\)ï¼Œè‹¥
        \(Q_{warm\to0}\le Q_{melt}=m_{ice}L_f\)ï¼Œå‰‡ \(T_f=0^\circ C\) ä¸”å°šæœ‰å†°æœªèã€‚<br/>
        è‹¥ \(Q_{warm\to0}>Q_{melt}\)ï¼Œé¤˜ç†± \(Q_{rem}\) ç”¨ä¾†æŠŠç³»çµ±ç”± 0Â°C å‡åˆ° \(T_f\)ï¼š\(
          T_f=\dfrac{Q_{rem}}{(m_a c_a^\*, m_b c_b^\*,\, C_{cal},\, m_{ice}c_{water})\text{ ä¹‹å’Œ}}
        \)ï¼ˆæ­¤æ™‚å†°å·²èç‚ºæ°´ï¼‰ã€‚
      </div>
    </div>

    <div id="panel-diagram" class="tab-panel">
      <p>å¯æŠŠæ¯ä¸€å€‹ç‰©ä»¶è¦–ç‚ºä¸€å€‹ã€Œç†±åº«ã€ã€‚ç†±æœƒè‡ªé«˜æº«æµå‘ä½æº«ï¼Œç›´åˆ°å„ç†±åº«æº«åº¦ç›¸åŒã€‚é¢ç©ä»£è¡¨ã€Œç†±å®¹é‡ã€
        \(m c\) æˆ– \(C_{cal}\)ã€‚åŠ å…¥å†°å¡Šæ™‚ï¼Œå…ˆå¡«æ»¿ã€Œç›¸è®Šéšæ¢¯ã€ï¼ˆæ½›ç†±ï¼‰ï¼Œå†é–‹å§‹å‡æº«ã€‚</p>
    </div>

    <div id="panel-scope" class="tab-panel">
      <ul>
        <li>å‡è¨­ï¼šç³»çµ±éš”ç†±è‰¯å¥½ï¼ˆç„¡ç†±æï¼‰ã€æ··åˆå……åˆ†ã€æ¯”ç†±èˆ‡ç›¸è®Šæ½›ç†±èˆ‡æº«åº¦ç„¡é—œï¼ˆè¿‘ä¼¼ï¼‰ã€‚</li>
        <li>é™åˆ¶ï¼šè‹¥å­˜åœ¨è’¸ç™¼ã€å®¹å™¨ç†±æã€æˆ–æº«å·®æ¥µå¤§ï¼Œæ¯”ç†±/æ½›ç†±å¯èƒ½éš¨æº«è®ŠåŒ–ï¼Œéœ€æ›´ç²¾ç´°æ¨¡å‹ã€‚</li>
      </ul>
    </div>

    <div id="panel-apps" class="tab-panel">
      <ul>
        <li>å’–å•¡åŠ å¥¶ã€èª¿æº«æ°´æµ´ã€ææ–™æ¯”ç†±é‡æ¸¬ã€‚</li>
        <li>ç”¨å·²çŸ¥ç†±å®¹çš„é‡ç†±å™¨é‡æ¸¬æœªçŸ¥æ¨£å“çš„æ¯”ç†±ã€‚</li>
      </ul>
    </div>

    <div id="panel-quiz" class="tab-panel">
      <ol>
        <li>0.2 kgã€80Â°C çš„æ°´èˆ‡ 0.3 kgã€20Â°C çš„æ°´æ··åˆï¼Œå¿½ç•¥é‡ç†±å™¨ï¼Œæ±‚ \(T_f\)ã€‚</li>
        <li>ä¸Šé¡Œè‹¥å®¹å™¨ç­‰æ•ˆç†±å®¹ 200 J/Kã€å®¹å™¨åˆæº« 20Â°Cï¼Œ\(T_f\) è®Šå¤šå°‘ï¼Ÿ</li>
        <li>0.05 kg çš„å†°ï¼ˆ0Â°Cï¼‰ä¸Ÿå…¥ 0.3 kgã€40Â°C çš„æ°´ï¼Œå®¹å™¨å¯å¿½ç•¥ã€‚æœ€çµ‚æº«åº¦èˆ‡æ®˜å†°ï¼Ÿ</li>
      </ol>
    </div>

    <div id="panel-ans" class="tab-panel">
      <details open><summary><b>é¡Œ 1</b></summary>
        æ°´ \(c=4186\)ã€‚\(T_f=\frac{0.2\cdot4186\cdot80+0.3\cdot4186\cdot20}{(0.2+0.3)\cdot4186}=44^\circ C\)ï¼ˆç´„ï¼‰ã€‚
      </details>
      <details><summary><b>é¡Œ 2</b></summary>
        åˆ†æ¯åŠ  \(C_{cal}\)ï¼Œåˆ†å­åŠ  \(C_{cal}T_{cal}\)ï¼›\(T_f\) æœƒç•¥é™ï¼ˆå› å®¹å™¨è¢«åŠ ç†±ï¼‰ã€‚
      </details>
      <details><summary><b>é¡Œ 3</b></summary>
        å…ˆç®—ç†±é‡æ˜¯å¦è¶³ä»¥èå†°ï¼ˆ\(L_fâ‰ˆ334\,000\) J/kgï¼‰ï¼Œå†ä¾å…¬å¼æ±‚ \(T_f\) æˆ–å›å ± 0Â°C èˆ‡æ®˜å†°é‡ã€‚
      </details>
    </div>
  </section>

  <div class="footer">Â© Calorimetry Lab Â· ç„¡ä»»å‹™ç‰ˆï¼ˆæ”¯æ´æ·±/æ·ºè‰²ä¸»é¡Œåˆ‡æ›ï¼‰</div>
</div>

<script>
/* ===== Materials (J/kgÂ·K) ===== */
const MATERIALS = [
  {name:"æ°´ Water", c:4186},
  {name:"ä¹™é†‡ Ethanol", c:2440},
  {name:"æ©„æ¬–æ²¹ Olive oil", c:1970},
  {name:"ç‰›å¥¶ Milk(è¿‘ä¼¼æ°´)", c:3900},
  {name:"é‹ Aluminum", c:900},
  {name:"éŠ… Copper", c:385},
  {name:"éµ/é‹¼ Iron/Steel", c:450},
];

/* ===== Shortcuts ===== */
const $ = id => document.getElementById(id);
const fmt = (n, d=2) => Number.isFinite(n) ? (Math.abs(n)<1e-3 ? n.toExponential(1) : n.toFixed(d)) : "â€”";

/* ===== Theme toggle ===== */
const root = document.documentElement;
const themeBtn = $('themeToggle');
function setTheme(t){ root.setAttribute('data-theme', t); themeBtn.textContent = t==='light'?'ğŸŒ ä¸»é¡Œï¼šæ·ºè‰²':'ğŸŒ— ä¸»é¡Œï¼šæ·±è‰²'; localStorage.setItem('cal_theme',t); }
setTheme(localStorage.getItem('cal_theme') || 'dark');
themeBtn.addEventListener('click', ()=> setTheme(root.getAttribute('data-theme')==='light'?'dark':'light'));

/* ===== Populate material selects ===== */
function fillMaterials(sel){
  MATERIALS.forEach((m,i)=>{
    const o=document.createElement('option'); o.value=i; o.textContent=`${m.name}ï¼ˆc=${m.c}ï¼‰`; sel.appendChild(o);
  });
}
fillMaterials($('matA')); fillMaterials($('matB'));
$('matA').value = 0; $('matB').value = 0;

/* ===== Bind sliders ===== */
const ids = ['mA','tA','mB','tB','Ccal','Tcal','mIce'];
const labels = ['mAv','tAv','mBv','tBv','Ccalv','Tcalv','mIcev'].map(id=>$(id));
ids.forEach((id, i)=>{
  const el=$(id);
  el.addEventListener('input', ()=>{
    labels[i].textContent = el.value;
  });
  labels[i].textContent = el.value;
});

/* ===== Charts (simple easing to Tf) ===== */
const chart = $('chart'), ctx = chart.getContext('2d');
let anim=null;
function drawCurve(series){
  ctx.clearRect(0,0,chart.width,chart.height);
  const pad=30, W=chart.width-pad*2, H=chart.height-pad*2;
  // axes
  ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--muted'); ctx.globalAlpha=0.5;
  ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, pad+H); ctx.lineTo(pad+W, pad+H); ctx.stroke(); ctx.globalAlpha=1;

  const tMax = Math.max(...series.map(s=>s.data.length));
  function plot(s,color){
    const ys=s.data, n=ys.length;
    if(n<2) return;
    ctx.strokeStyle=color; ctx.lineWidth=2; ctx.beginPath();
    ys.forEach((y,i)=>{
      const x = pad + i*(W/(tMax-1));
      const yv = pad+H - (y - s.min)/(s.max-s.min || 1) * H;
      i?ctx.lineTo(x,yv):ctx.moveTo(x,yv);
    });
    ctx.stroke();
  }
  series.forEach((s,idx)=>plot(s, ['#60a5fa','#f97316','#10b981','#a78bfa'][idx%4]));
}

/* ===== Core calculation ===== */
const Lf = 334000;         // å†°çš„ç†”åŒ–æ½›ç†± J/kg
const cW = 4186;           // æ°´çš„æ¯”ç†±

function compute(){
  const mA=+$('mA').value, tA=+$('tA').value, cA=MATERIALS[+$('matA').value].c;
  const mB=+$('mB').value, tB=+$('tB').value, cB=MATERIALS[+$('matB').value].c;
  const Ccal=+$('Ccal').value, Tcal=+$('Tcal').value;
  const mIce=+$('mIce').value;

  let Tf, Qa, Qb, Qcal, Qice = 0, iceLeft = 0;

  if(mIce<=0){
    // Analytical mix (no phase change)
    const denom = mA*cA + mB*cB + Ccal;
    const numer = mA*cA*tA + mB*cB*tB + Ccal*Tcal;
    Tf = numer/denom;

    Qa = mA*cA*(Tf - tA);
    Qb = mB*cB*(Tf - tB);
    Qcal = Ccal*(Tf - Tcal);
  }else{
    // With ice at 0Â°C
    // 1) heat available if everything cooled/warmed to 0Â°C
    const Qwarm_to0 =
      (tA>0 ? mA*cA*(tA-0) : 0) +
      (tB>0 ? mB*cB*(tB-0) : 0) +
      (Tcal>0 ? Ccal*(Tcal-0) : 0);

    const Qmelt = mIce * Lf;

    if(Qwarm_to0 <= Qmelt){
      // not enough to melt all ice
      Tf = 0;
      const melted = Qwarm_to0 / Lf;
      iceLeft = Math.max(mIce - melted, 0);
      // Energies: all warm parts cool to 0, some ice melts
      Qa = (tA>0 ? mA*cA*(0 - tA) : mA*cA*(0 - tA)); // both sides to 0; sign convention: positive = heat absorbed
      Qb = (tB>0 ? mB*cB*(0 - tB) : mB*cB*(0 - tB));
      Qcal = (Tcal>0 ? Ccal*(0 - Tcal) : Ccal*(0 - Tcal));
      Qice = melted*Lf; // absorbed by ice (positive)
    }else{
      // all ice melts, remaining heat raises temperature from 0 to Tf
      const Qrem = Qwarm_to0 - Qmelt;
      const cap = ( (tA>0? mA*cA: mA*cA) + (tB>0? mB*cB: mB*cB) + Ccal + mIce*cW );
      // å…¶å¯¦ä¸è«–æ­£è² ï¼Œé™åˆ° 0 å¾Œå¤§å®¶éƒ½åœ¨ 0 èµ·æ­¥å‡æº«ï¼Œå› æ­¤ç¸½ç†±å®¹ = ä¸Šå¼
      Tf = Qrem / cap;

      // Energiesï¼ˆç›¸å°åŸå§‹åˆæº«ï¼‰ï¼š
      // Aï¼šè‹¥ tA>0ï¼Œå…ˆæ”¾å‡º mA cA tAï¼Œå¾Œåœ¨å‡æº«éšæ®µå†å¸æ”¶ mA cA Tf â†’ åˆä½µï¼šmA cA (Tf - tA)
      //    è‹¥ tA=0ï¼Œç›´æ¥ mA cA Tfï¼›è‹¥ tA<0ï¼ˆä¸çµ¦è² æº« sliderï¼‰ï¼Œæ­¤è™•ç•¥
      Qa = mA*cA*(Tf - tA);
      Qb = mB*cB*(Tf - tB);
      Qcal = Ccal*(Tf - Tcal);
      Qice = mIce*Lf + mIce*cW*(Tf - 0); // èåŒ–ï¼‹å‡æº«
      iceLeft = 0;
    }
  }

  const sumQ = Qa + Qb + Qcal + Qice;

  // Write readouts
  $('Tf').textContent = fmt(Tf,2);
  $('Qa').textContent = fmt(Qa,1);
  $('Qb').textContent = fmt(Qb,1);
  $('Qcal').textContent = fmt(Qcal,1);
  $('Qice').textContent = fmt(Qice,1);
  $('sumQ').textContent = fmt(sumQ,1);
  $('iceLeft').textContent = fmt(iceLeft,3);

  return {Tf, Qa, Qb, Qcal, Qice};
}

/* ===== Simple time animation to Tf ===== */
function runAnimation(TinitA, TinitB, TinitCal, Tf){
  if(anim) cancelAnimationFrame(anim);
  const steps = 180; const k = 0.035; // easing rate
  const sA = {data:[TinitA], min:Math.min(0,TinitA,Tf), max:Math.max(100,TinitA,Tf)};
  const sB = {data:[TinitB], min:sA.min, max:sA.max};
  const sC = {data:[TinitCal], min:sA.min, max:sA.max};

  let i=1;
  function tick(){
    sA.data.push( sA.data[i-1] + (Tf - sA.data[i-1]) * (1 - Math.exp(-k)) );
    sB.data.push( sB.data[i-1] + (Tf - sB.data[i-1]) * (1 - Math.exp(-k*1.1)) );
    sC.data.push( sC.data[i-1] + (Tf - sC.data[i-1]) * (1 - Math.exp(-k*0.9)) );
    drawCurve([
      {data:sA.data, min:sA.min, max:sA.max},
      {data:sB.data, min:sA.min, max:sA.max},
      {data:sC.data, min:sA.min, max:sA.max},
    ]);
    i++; if(i<=steps) anim = requestAnimationFrame(tick);
  }
  drawCurve([{data:sA.data,min:sA.min,max:sA.max},{data:sB.data,min:sA.min,max:sA.max},{data:sC.data,min:sA.min,max:sA.max}]);
  anim = requestAnimationFrame(tick);
}

/* ===== Tabs ===== */
const tabs = document.querySelectorAll('.tab-list .tab');
const panels = {
  law:$('panel-law'), formula:$('panel-formula'), diagram:$('panel-diagram'),
  scope:$('panel-scope'), apps:$('panel-apps'), quiz:$('panel-quiz'), ans:$('panel-ans')
};
tabs.forEach(btn=>{
  btn.addEventListener('click',()=>{
    tabs.forEach(b=>b.setAttribute('aria-selected','false'));
    btn.setAttribute('aria-selected','true');
    Object.values(panels).forEach(p=>p.classList.remove('active'));
    panels[btn.dataset.tab].classList.add('active');
  });
});

/* ===== Buttons ===== */
$('runSim').addEventListener('click', ()=>{
  const tA=+$('tA').value, tB=+$('tB').value, tC=+$('Tcal').value;
  const {Tf} = compute();
  if(Number.isFinite(Tf)) runAnimation(tA,tB,tC,Tf);
});
$('reset').addEventListener('click', ()=>{
  $('matA').value=0; $('matB').value=0;
  $('mA').value=0.5; $('tA').value=70; $('mB').value=0.8; $('tB').value=20;
  $('Ccal').value=200; $('Tcal').value=20; $('mIce').value=0;
  ids.forEach((id,i)=> labels[i].textContent = $(id).value );
  compute(); ctx.clearRect(0,0,chart.width,chart.height);
});

/* ===== Init ===== */
compute();
</script>
</body>
</html>
