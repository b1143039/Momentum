<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gravitationï½œè¬æœ‰å¼•åŠ›</title>
<style>
/* ===== Theme ===== */
:root{
  /* Dark (default) */
  --bg:#0b1020; --panel:#11162f; --card:#131a38; --text:#eaf0ff; --muted:#9fb0d0;
  --border:rgba(255,255,255,.12); --brand:#6ee7ff; --brand2:#a78bfa; --accent:#34d399;
  --shadow:0 10px 30px rgba(0,0,0,.35); --r:16px;
  --trail:rgba(255,255,255,.9); --grid:rgba(255,255,255,.06);
}
:root.light{
  /* Light */
  --bg:#f5f7fb; --panel:#ffffff; --card:#ffffff; --text:#0b1020; --muted:#566076;
  --border:rgba(0,0,0,.12); --brand:#06b6d4; --brand2:#8b5cf6; --accent:#10b981;
  --shadow:0 10px 24px rgba(0,0,0,.08);
  --trail:rgba(18,30,60,.9); --grid:rgba(0,0,0,.08);
}

*{box-sizing:border-box}
body{
  margin:0; padding:22px 14px; color:var(--text);
  font-family:ui-sans-serif,system-ui,"Segoe UI","Noto Sans TC","PingFang TC","Microsoft JhengHei";
  background:
    radial-gradient(1100px 650px at 0% -10%, color-mix(in oklab,var(--brand) 18%, transparent), transparent 60%),
    radial-gradient(900px 600px at 100% 0%, color-mix(in oklab,var(--brand2) 20%, transparent), transparent 60%),
    var(--bg);
}
.container{max-width:1150px;margin:0 auto}
.card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:12px;box-shadow:var(--shadow)}
h1{margin:0 0 6px;font-size:28px}
.sub{color:var(--muted);font-size:14px}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.badge{background:color-mix(in oklab,var(--card) 60%, transparent);border:1px solid var(--border);padding:4px 10px;border-radius:999px;font-size:12px}
.header{display:flex;justify-content:space-between;align-items:center;gap:10px}
.header-right{display:flex;gap:8px;align-items:center}
button,select{height:36px;border-radius:10px;border:1px solid var(--border);background:#10173a;color:#eaf0ff;padding:0 10px;cursor:pointer}
:root.light button,:root.light select{background:#f8fafc;color:var(--text)}
button.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#05222b;border-color:transparent}
button:hover{filter:brightness(1.06)}
button:disabled{opacity:.55;cursor:not-allowed}

.grid2{display:grid;grid-template-columns:1.05fr .95fr;gap:14px;margin-top:14px}
@media (max-width:980px){.grid2{grid-template-columns:1fr}}

.row{display:flex;align-items:center;gap:10px;margin:8px 0}
label{font-size:14px;color:#b8c6e3}
:root.light label{color:#465167}
.value{margin-left:auto}
input[type=range]{width:100%}
hr.sep{border:none;height:1px;background:var(--border);margin:10px 0}
.canvas-wrap{margin-top:14px}

/* canvases */
#space{width:100%;height:520px;border:1px dashed var(--border);border-radius:12px;display:block;
  background:radial-gradient(circle at 50% 50%,#000 25%,#07102a 85%)}
:root.light #space{background:radial-gradient(circle at 50% 50%,#dfe8ff 8%,#eef2ff 55%,#f7fafc 100%)}
#energy{width:100%;height:220px;border:1px dashed var(--border);border-radius:12px;display:block;margin-top:8px;background:#0e1430}
:root.light #energy{background:#f8fbff}

.k{color:#60a5fa}.u{color:#fca5a5}.e{color:#34d399}
.readout{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:6px}
.item{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px}
.item .label{font-size:12px;color:#b8c6e3}
:root.light .item .label{color:#566076}
.item .val{font-size:18px;font-weight:800}
.footer{color:var(--muted);font-size:12px;text-align:center;margin-top:16px}

/* ===== Tabs ===== */
.tabs{margin-top:14px}
.tab-list{display:flex;gap:8px;flex-wrap:wrap}
.tab-list .tab{
  background:transparent;border:1px solid var(--border);color:var(--muted);
  border-radius:10px;padding:8px 14px;font-size:15px;cursor:pointer
}
.tab-list .tab[aria-selected="true"]{
  background:linear-gradient(135deg, color-mix(in oklab,var(--brand) 25%, transparent), color-mix(in oklab,var(--brand2) 25%, transparent));
  color:var(--text); box-shadow:0 0 12px color-mix(in oklab,var(--brand) 35%, transparent)
}
.tab-panel{display:none;margin-top:10px;font-size:17px;line-height:1.8}
.tab-panel.active{display:block;animation:fade .2s ease}
@keyframes fade {from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none}}
.formula-block{text-align:center;font-size:19px;background:color-mix(in oklab,var(--card) 70%, transparent);border:1px dashed var(--border);border-radius:10px;margin:10px 0;padding:10px}
#panel-quiz ol li{
  background:color-mix(in oklab,var(--card) 65%, transparent); border-left:4px solid var(--brand2);
  padding:8px 12px; border-radius:8px; margin-bottom:10px; font-size:17px; font-weight:500
}
</style>

<script>window.MathJax={tex:{inlineMath:[['\\(','\\)'],['$','$']]}};</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
<div class="container">

  <!-- Header -->
  <section class="card header">
    <div>
      <h1>Gravitationï½œè¬æœ‰å¼•åŠ›</h1>
      <div class="sub">å¤ªé™½å›ºå®šä¸­å¤®ï¼Œåƒ… 1 é¡†è¡Œæ˜Ÿï¼›è®€æ•¸æ¡ç§‘å­¸è¨˜è™Ÿã€‚</div>
      <div class="badges"><span class="badge">å–®è¡Œæ˜Ÿ</span><span class="badge">ä¸­å¤®å¤ªé™½</span><span class="badge">é€Ÿåº¦/åŠ é€Ÿåº¦/è»Œè·¡ é–‹é—œ</span></div>
    </div>
    <div class="header-right">
      <button id="themeBtn" class="primary" aria-label="åˆ‡æ›ä¸»é¡Œ">ğŸŒ“ ä¸»é¡Œ</button>
    </div>
  </section>

  <section class="grid2">
    <!-- Controls -->
    <div class="card">
      <h3 style="margin:6px 0 8px">æ§åˆ¶åˆ—</h3>
      <div class="row"><label>æ™‚é–“å€ç‡ Ã— <span class="value" id="timeVal">1.0</span></label><input id="time" type="range" min="0.1" max="5" step="0.1" value="1"></div>
      <div class="row"><label>å°¾è·¡é•·åº¦ï¼ˆé»æ•¸ï¼‰<span class="value" id="trailVal">800</span></label><input id="trail" type="range" min="100" max="1500" step="50" value="800"></div>
      <div class="row">
        <label>é¡¯ç¤º</label>
        <label><input type="checkbox" id="showTrail" checked> è»Œè·¡</label>
        <label><input type="checkbox" id="showV" checked> é€Ÿåº¦</label>
        <label><input type="checkbox" id="showA" checked> åŠ é€Ÿåº¦</label>
        <label><input type="checkbox" id="showGrid"> ç¶²æ ¼</label>
      </div>
      <hr class="sep">
      <h3 style="margin:6px 0 8px">æ–°å¢è¡Œæ˜Ÿï¼ˆä¸Šé™ 1 é¡†ï¼‰</h3>
      <div class="row"><label>åŠå¾‘ rï¼ˆç™¾è¬ kmï¼‰<span class="value" id="rVal">150</span></label><input id="r0" type="range" min="30" max="500" step="5" value="150"></div>
      <div class="row"><label>åˆé€Ÿ vï¼ˆkm/sï¼‰<span class="value" id="vVal">30</span></label><input id="v0" type="range" min="0" max="80" step="1" value="30"></div>
      <div class="row"><label>é€Ÿåº¦æ–¹å‘</label>
        <select id="vdir"><option value="tangent">åˆ‡å‘</option><option value="radial">å¾‘å‘</option><option value="custom">è‡ªè¨‚è§’</option></select>
      </div>
      <div class="row" id="customRow" style="display:none"><label>è‡ªè¨‚è§’ï¼ˆÂ°ï¼‰<span class="value" id="phiVal">0</span></label><input id="phi" type="range" min="-90" max="90" step="1" value="0"></div>
      <div class="row"><button class="primary" id="addPlanet">ï¼‹ æ–°å¢è¡Œæ˜Ÿ</button><button id="reset">é‡è¨­</button></div>
      <div class="sub" id="msg" style="margin-top:6px;color:#ffd166"></div>
    </div>

    <!-- Readout -->
    <div class="card">
      <h3 style="margin:6px 0 8px">è®€æ•¸ï¼èƒ½é‡</h3>
      <div class="readout">
        <div class="item"><div class="label">åŠå¾‘ rï¼ˆkmï¼‰</div><div class="val" id="rr">â€”</div></div>
        <div class="item"><div class="label">é€Ÿç‡ vï¼ˆkm/sï¼‰</div><div class="val" id="rv">â€”</div></div>
        <div class="item"><div class="label">æ¯”å‹•èƒ½ kï¼ˆMJ/kgï¼‰</div><div class="val k" id="rk">â€”</div></div>
        <div class="item"><div class="label">æ¯”ä½èƒ½ uï¼ˆMJ/kgï¼‰</div><div class="val u" id="ru">â€”</div></div>
        <div class="item"><div class="label">æ¯”ç¸½èƒ½ eï¼ˆMJ/kgï¼‰</div><div class="val e" id="re">â€”</div></div>
        <div class="item"><div class="label">èƒ½é‡åˆ¤æ–·</div><div class="val" id="rtype">â€”</div></div>
      </div>
      <canvas id="energy" width="1000" height="220"></canvas>
    </div>
  </section>

  <!-- Space -->
  <section class="card canvas-wrap">
    <canvas id="space" width="1100" height="520"></canvas>
  </section>

  <!-- Learning Tabs -->
  <section class="card tabs">
    <div class="tab-list" role="tablist" aria-label="å­¸ç¿’åˆ†é ">
      <button class="tab" role="tab" aria-selected="true" data-tab="law">å®šå¾‹å…§å®¹</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="formula">å…¬å¼è¡¨ç¤º</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="diagram">åœ–åƒç†è§£</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="scope">é©ç”¨ç¯„åœ</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="apps">å¸¸è¦‹æ‡‰ç”¨</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="quiz">æ•™å­¸å»¶ä¼¸å•é¡Œ</button>
      <button class="tab" role="tab" aria-selected="false" data-tab="ans">å»¶ä¼¸å•é¡Œè§£ç­”</button>
    </div>

    <div id="panel-law" class="tab-panel active">
      <ul>
        <li><b>è¬æœ‰å¼•åŠ›å®šå¾‹</b>ï¼šå…©è³ªé»é–“å¼•åŠ› \(F=\dfrac{G m_1 m_2}{r^2}\)ï¼Œæ–¹å‘æ²¿é€£å¿ƒç·šã€‚</li>
        <li><b>è»Œé“è§€é»</b>ï¼šå¤ªé™½è³ªé‡ \(M\) é å¤§æ–¼è¡Œæ˜Ÿï¼Œè¿‘ä¼¼ä¸­å¿ƒåŠ›å•é¡Œã€‚</li>
        <li><b>èƒ½é‡è§€é»</b>ï¼šæ¯”æ©Ÿæ¢°èƒ½ \(\varepsilon=\dfrac{v^2}{2}-\dfrac{\mu}{r}\)ï¼ˆ\(\mu=GM\)ï¼‰ã€‚\(\varepsilon<0\)ï¼šæŸç¸›ï¼ˆæ©¢åœ“/åœ“ï¼‰ï¼›\(\varepsilon=0\)ï¼šæ‹‹ç‰©ï¼›\(\varepsilon>0\)ï¼šé›™æ›²ã€‚</li>
        <li><b>é€Ÿåº¦æ¨™å°º</b>ï¼šåœ“è»Œé“ \(v_c=\sqrt{\mu/r}\)ï¼Œé€ƒé€¸ \(v_e=\sqrt{2\mu/r}\)ã€‚</li>
      </ul>
    </div>

    <div id="panel-formula" class="tab-panel">
      <div class="formula-block">å¼•åŠ›ï¼š\( \vec F = -\,\dfrac{GMm}{r^3}\,\vec r \)</div>
      <div class="formula-block">æ¯”ä½èƒ½ï¼š\( u(r) = -\dfrac{\mu}{r} \)ï¼Œæ¯”å‹•èƒ½ï¼š\( k=\dfrac{v^2}{2} \)ï¼Œæ¯”ç¸½èƒ½ï¼š\( \varepsilon=k+u \)</div>
      <div class="formula-block">è¦–-ä¼ï¼ˆVis-Vivaï¼‰å¼ï¼š\( v^2=\mu\!\left(\dfrac{2}{r}-\dfrac{1}{a}\right) \)ï¼ˆ\(a\) ç‚ºæ©¢åœ“åŠé•·è»¸ï¼›åœ“è»Œé“ \(a=r\)ï¼‰</div>
      <div class="formula-block">é–‹æ™®å‹’ç¬¬ä¸‰å®šå¾‹ï¼š\( T=2\pi\sqrt{\dfrac{a^3}{\mu}} \)</div>
      <div class="formula-block">åŠ é€Ÿåº¦ï¼ˆå‘å¿ƒï¼‰ï¼š\( \vec a = -\,\dfrac{\mu}{r^3}\,\vec r \)</div>
    </div>

    <div id="panel-diagram" class="tab-panel">
      <figure style="text-align:center; margin:6px 0 10px">
        <svg width="640" height="160" viewBox="0 0 640 160" role="img" aria-label="ä¸­å¿ƒåŠ›åœ“è»Œé“ç¤ºæ„">
          <defs>
            <marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto">
              <path d="M0 0 L10 5 L0 10 Z" fill="#6ee7ff"></path>
            </marker>
          </defs>
          <!-- Sun -->
          <radialGradient id="sunG" cx="50%" cy="50%" r="60%">
            <stop offset="0%" stop-color="#fff6b0"/><stop offset="100%" stop-color="#ff8f00"/>
          </radialGradient>
          <circle cx="120" cy="80" r="20" fill="url(#sunG)" stroke="rgba(255,255,255,.5)"/>
          <text x="120" y="80" text-anchor="middle" dy="4" font-size="10" fill="#2b0c0c">Sun</text>

          <!-- Orbit -->
          <circle cx="120" cy="80" r="70" fill="none" stroke="rgba(255,255,255,.35)"/>
          <!-- Planet -->
          <circle cx="190" cy="80" r="7" fill="#6ee7ff"/>
          <!-- r -->
          <line x1="120" y1="80" x2="190" y2="80" stroke="#9fb0d0" stroke-dasharray="4 4"/>
          <text x="155" y="70" font-size="12" fill="#9fb0d0">r</text>
          <!-- v (tangent) -->
          <line x1="190" y1="80" x2="190" y2="50" stroke="#a78bfa" stroke-width="2" marker-end="url(#arrow)"/>
          <text x="196" y="55" font-size="12" fill="#a78bfa">v</text>
          <!-- a (to center) -->
          <line x1="190" y1="80" x2="150" y2="80" stroke="#34d399" stroke-width="2" marker-end="url(#arrow)"/>
          <text x="165" y="72" font-size="12" fill="#34d399">a</text>
        </svg>
        <figcaption class="sub">åœ“è»Œé“æ™‚ \( \vec v \perp \vec r \)ã€åŠ é€Ÿåº¦æŒ‡å‘ä¸­å¿ƒï¼›\(v=\sqrt{\mu/r}\)ã€‚</figcaption>
      </figure>
    </div>

    <div id="panel-scope" class="tab-panel">
      <ul>
        <li>å‡è¨­å¤ªé™½é å¤§æ–¼è¡Œæ˜Ÿï¼ˆ\(\,M\gg m\)ï¼‰ï¼Œå¯è¦–ç‚ºå›ºå®šçš„ä¸­å¿ƒåŠ›ã€‚</li>
        <li>åªè€ƒæ…®å¼•åŠ›ï¼›å¿½ç•¥å…¶ä»–è¡Œæ˜Ÿæ“¾å‹•ã€éçƒå½¢å¼•åŠ›ã€ç›¸å°è«–ä¿®æ­£ã€‚</li>
        <li>æ¨¡æ“¬æ¡æ•¸å€¼ç©åˆ†ï¼Œæ­¥é•·éå¤§å¯èƒ½å°è‡´èƒ½é‡å¾®å°æ¼‚ç§»ï¼ˆæ•™å­¸å¯æ¥å—ï¼‰ã€‚</li>
      </ul>
    </div>

    <div id="panel-apps" class="tab-panel">
      <ul>
        <li>è¡Œæ˜Ÿèˆ‡äººé€ è¡›æ˜Ÿè»Œé“è¨­è¨ˆï¼ˆè½‰ç§»è»Œé“ã€éœæ›¼è½‰ç§»ï¼‰ã€‚</li>
        <li>é€ƒé€¸é€Ÿåº¦èˆ‡ä»»å‹™èƒ½é‡ä¼°ç®—ï¼ˆ\(\Delta v\) é ç®—ï¼‰ã€‚</li>
        <li>é‡åŠ›åŠ©æ¨ï¼ˆSwing-byï¼‰ç›´è§€åŒ–ï¼šèƒ½é‡åœ¨åƒè€ƒæ¡†æ¶ä¸‹çš„è½‰æ›ã€‚</li>
      </ul>
    </div>

    <div id="panel-quiz" class="tab-panel">
      <ol>
        <li>è‹¥ \(r=1.5\times10^{11}\,\text{m}\)ï¼šæ±‚åœ“è»Œé“é€Ÿåº¦ \(v_c\)ã€‚</li>
        <li>åœ¨åŒä¸€åŠå¾‘ \(r\)ï¼Œé€ƒé€¸é€Ÿåº¦èˆ‡åœ“è»Œé“é€Ÿåº¦ä¹‹æ¯”ç‚ºï¼Ÿ</li>
        <li>å·²çŸ¥ \(r=2.0\times10^{11}\,\text{m}\)ã€\(v=20\,\text{km/s}\)ã€‚åˆ¤æ–·è»Œé“é¡å‹ï¼ˆç”¨ \(\varepsilon\)ï¼‰ã€‚</li>
        <li>æ©¢åœ“è»Œé“åŠé•·è»¸ \(a=1.2\times10^{11}\,\text{m}\)ï¼šæ±‚é€±æœŸ \(T\)ï¼ˆ\(\mu=GM\)ï¼‰ã€‚</li>
      </ol>
    </div>

    <div id="panel-ans" class="tab-panel">
      <details open><summary><b>é¡Œ 1</b></summary>
        \(v_c=\sqrt{\mu/r}=\sqrt{(GM)/r}\approx 29.8\,\text{km/s}\)ï¼ˆå–å¤ªé™½ \(\mu\approx1.327\times10^{20}\,\text{m}^3/\text{s}^2\)ï¼‰ã€‚
      </details>
      <details><summary><b>é¡Œ 2</b></summary>
        \(v_e=\sqrt{2\mu/r}=\sqrt{2}\,v_c\)ï¼Œæ¯”å€¼ \(\sqrt{2}\approx1.414\)ã€‚
      </details>
      <details><summary><b>é¡Œ 3</b></summary>
        \(\varepsilon=\dfrac{v^2}{2}-\dfrac{\mu}{r}\)ã€‚ä»£å…¥å¾Œè‹¥ \(\varepsilon<0\) å‰‡æŸç¸›ï¼›ä»¥æ•¸å€¼ä¼°ç®—æœƒå¾—åˆ° \(\varepsilon<0\)ï¼ˆæŸç¸›æ©¢åœ“ï¼‰ã€‚
      </details>
      <details><summary><b>é¡Œ 4</b></summary>
        \(T=2\pi\sqrt{a^3/\mu}\)ã€‚ä»£å…¥ \(a\) èˆ‡å¤ªé™½ \(\mu\) å³å¾—æ•¸å€¼ï¼ˆå–®ä½ç§’ï¼›å¯å†æ›æˆå¤©ï¼‰ã€‚
      </details>
    </div>
  </section>
</div>

<script>
/* ---------- Theme toggle (persist) ---------- */
const root=document.documentElement, themeBtn=document.getElementById('themeBtn');
(function initTheme(){
  const saved=localStorage.getItem('theme');
  if(saved==='light') root.classList.add('light');
  else if(saved==='dark') root.classList.remove('light');
  else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
    root.classList.add('light');
  }
})();
themeBtn.addEventListener('click',()=>{
  root.classList.toggle('light');
  localStorage.setItem('theme', root.classList.contains('light')?'light':'dark');
});

/* ---------- Tabs ---------- */
const tabs=[...document.querySelectorAll('.tab-list .tab')];
const panels={
  law:document.getElementById('panel-law'),
  formula:document.getElementById('panel-formula'),
  diagram:document.getElementById('panel-diagram'),
  scope:document.getElementById('panel-scope'),
  apps:document.getElementById('panel-apps'),
  quiz:document.getElementById('panel-quiz'),
  ans:document.getElementById('panel-ans')
};
tabs.forEach(btn=>{
  btn.addEventListener('click',()=>{
    tabs.forEach(b=>b.setAttribute('aria-selected','false'));
    btn.setAttribute('aria-selected','true');
    Object.values(panels).forEach(p=>p.classList.remove('active'));
    panels[btn.dataset.tab].classList.add('active');
  });
});

/* ---------- Utils ---------- */
const $=id=>document.getElementById(id);
const sciHTML=(n,unit="")=>{
  if(!Number.isFinite(n)) return "â€”";
  if(n===0) return "0"+unit;
  const e=Math.floor(Math.log10(Math.abs(n)));
  const m=n/10**e;
  return `${m.toFixed(3)}Ã—10<sup>${e}</sup>${unit}`;
};
/* HiDPI canvas */
function setupCanvas(canvas){
  const dpr=window.devicePixelRatio||1;
  const rect=canvas.getBoundingClientRect();
  canvas.width=Math.round(rect.width*dpr);
  canvas.height=Math.round(rect.height*dpr);
  const ctx=canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return ctx;
}

/* ---------- Canvases ---------- */
const sp=$("space"), sctx=setupCanvas(sp);
const ec=$("energy"), ectx=setupCanvas(ec);
const W=sp.getBoundingClientRect().width, H=sp.getBoundingClientRect().height;

/* ---------- Phys ---------- */
const G=6.674e-11, M=1.989e30;
let sunX=W/2, sunY=H/2;
let metersPerPixel=1.5e9, timeFactor=1, trailMax=800;
let showTrail=true,showV=true,showA=true,showGrid=false;
let planets=[]; const MAX_PLANETS=1;

/* ---------- Starfield ---------- */
const stars=document.createElement("canvas"); stars.width=W; stars.height=H;
const sc=stars.getContext("2d");
for(let i=0;i<230;i++){
  sc.fillStyle=`rgba(255,255,255,${0.35+Math.random()*0.65})`;
  sc.beginPath(); sc.arc(Math.random()*W,Math.random()*H,Math.random()*1.2,0,Math.PI*2); sc.fill();
}

/* ---------- UI ---------- */
$("time").oninput=e=>{timeFactor=+e.target.value;$("timeVal").textContent=timeFactor.toFixed(1)};
$("trail").oninput=e=>{trailMax=+e.target.value;$("trailVal").textContent=trailMax};
$("showTrail").onchange=e=>{showTrail=e.target.checked};
$("showV").onchange=e=>{showV=e.target.checked};
$("showA").onchange=e=>{showA=e.target.checked};
$("showGrid").onchange=e=>{showGrid=e.target.checked};
["r0","v0","phi"].forEach(id=>$(id).oninput=syncMini);
$("vdir").onchange=()=>{$("customRow").style.display=$("vdir").value==="custom"?"flex":"none"};
function syncMini(){$("rVal").textContent=$("r0").value;$("vVal").textContent=$("v0").value;$("phiVal").textContent=$("phi").value;}
function updateAddButton(){$("addPlanet").disabled=planets.length>=MAX_PLANETS;}
function addPlanet(rMkm=150,vKms=30,vdir="tangent",phiDeg=0){
  if(planets.length>=MAX_PLANETS){$("msg").textContent="âš ï¸ åƒ…å…è¨± 1 é¡†è¡Œæ˜Ÿ";return;}
  const theta=270*Math.PI/180;  // åˆå§‹åœ¨ä¸‹æ–¹
  const r=rMkm*1e9, x=r*Math.cos(theta), y=r*Math.sin(theta);
  let ang=theta+Math.PI/2;      // åˆ‡å‘
  if(vdir==="radial") ang=theta;
  if(vdir==="custom") ang+=phiDeg*Math.PI/180;
  const vx=vKms*1000*Math.cos(ang), vy=vKms*1000*Math.sin(ang);
  planets=[{x,y,vx,vy,m:5.97e24,color:"#6ee7ff",trail:[]}];
  updateAddButton(); $("msg").textContent="";
}
$("addPlanet").onclick=()=>addPlanet(+$("r0").value,+$("v0").value,$("vdir").value,+$("phi").value);
$("reset").onclick=()=>{planets=[];updateAddButton();};

/* ---------- Scale & coords ---------- */
function updateScale(){
  const maxR=Math.max(1.5e11,...planets.map(p=>Math.hypot(p.x,p.y)));
  metersPerPixel=(maxR*1.15)/(Math.min(W,H)*0.45);
}
function toCanvas(x,y){return [sunX+x/metersPerPixel,sunY+y/metersPerPixel];}

/* ---------- Energy ---------- */
const kSpec=p=>0.5*(p.vx*p.vx+p.vy*p.vy);
const uSpec=p=>-G*M/Math.hypot(p.x,p.y);
const eSeries=[];function pushE(d){eSeries.push(d);if(eSeries.length>600)eSeries.shift();}
function drawEnergy(){
  ectx.clearRect(0,0,ec.width,ec.height);
  if(eSeries.length<2)return;
  const vals=eSeries.flatMap(d=>[d.k,d.u,d.e]);
  const vmin=Math.min(...vals), vmax=Math.max(...vals), pad=0.1*(vmax-vmin||1);
  const yMin=vmin-pad, yMax=vmax+pad;
  const X=i=>40+i*(ec.width-50)/(eSeries.length-1);
  const Y=v=>(ec.height-20)-(v-yMin)*(ec.height-30)/(yMax-yMin);
  const plot=(key,c)=>{ectx.strokeStyle=c; ectx.beginPath();
    eSeries.forEach((d,i)=>{const x=X(i),y=Y(d[key]); i?ectx.lineTo(x,y):ectx.moveTo(x,y);});
    ectx.stroke();
  };
  plot("k","#60a5fa"); plot("u","#fca5a5"); plot("e","#34d399");
}

/* ---------- Integrator ---------- */
function step(){
  const sub=2, dt=(3600*timeFactor)/sub;
  for(let s=0;s<sub;s++){
    for(const p of planets){
      const dx=-p.x, dy=-p.y;
      const r2=dx*dx+dy*dy; const r=Math.sqrt(r2)||1;
      const invr3=1/(r2*r);
      const ax=G*M*dx*invr3, ay=G*M*dy*invr3;
      p.vx+=ax*dt; p.vy+=ay*dt;
      p.x+=p.vx*dt; p.y+=p.vy*dt;
      p.trail.push([p.x,p.y]); if(p.trail.length>trailMax)p.trail.shift();
    }
  }
}

/* ---------- Sun ---------- */
function drawSun(){
  sctx.save();
  sctx.globalAlpha=1; sctx.globalCompositeOperation='source-over';
  const R=26;
  const g1=sctx.createRadialGradient(sunX,sunY,0,sunX,sunY,R*2.2);
  g1.addColorStop(0,"rgba(255,200,80,.35)");
  g1.addColorStop(1,"rgba(255,200,80,0)");
  sctx.fillStyle=g1; sctx.beginPath(); sctx.arc(sunX,sunY,R*2.2,0,Math.PI*2); sctx.fill();

  const g2=sctx.createRadialGradient(sunX,sunY,0,sunX,sunY,R);
  g2.addColorStop(0,"#fff6b0"); g2.addColorStop(1,"#ff8f00");
  sctx.fillStyle=g2; sctx.beginPath(); sctx.arc(sunX,sunY,R,0,Math.PI*2); sctx.fill();

  sctx.strokeStyle="rgba(255,255,255,.6)"; sctx.lineWidth=1;
  sctx.beginPath(); sctx.arc(sunX,sunY,R,0,Math.PI*2); sctx.stroke();
  sctx.restore();
}

/* ---------- Draw ---------- */
function draw(){
  sctx.clearRect(0,0,W,H);
  sctx.drawImage(stars,0,0);

  if(showGrid){
    sctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid').trim()||"rgba(255,255,255,.06)";
    for(let x=sunX%100;x<W;x+=100){sctx.beginPath();sctx.moveTo(x,0);sctx.lineTo(x,H);sctx.stroke();}
    for(let y=sunY%100;y<H;y+=100){sctx.beginPath();sctx.moveTo(0,y);sctx.lineTo(W,y);sctx.stroke();}
  }

  drawSun();

  const vmax=Math.max(1,...planets.map(p=>Math.hypot(p.vx,p.vy)/1000));
  const vScale=70/vmax;

  planets.forEach(p=>{
    // Trail
    if(showTrail && p.trail.length>1){
      sctx.beginPath(); sctx.lineWidth=1.4;
      sctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--trail').trim()||"rgba(255,255,255,.9)";
      p.trail.forEach((q,j)=>{const [tx,ty]=toCanvas(q[0],q[1]); j?sctx.lineTo(tx,ty):sctx.moveTo(tx,ty);});
      sctx.stroke(); sctx.lineWidth=1;
    }

    // Planet
    const [x,y]=toCanvas(p.x,p.y);
    sctx.beginPath(); sctx.arc(x,y,6,0,Math.PI*2); sctx.fillStyle="#6ee7ff"; sctx.fill();
    sctx.fillStyle="#cbd5e1"; sctx.font="12px ui-sans-serif"; sctx.fillText("Planet 1", x+8, y-8);

    // V vector
    if(showV){
      sctx.strokeStyle="#a78bfa";
      sctx.beginPath(); sctx.moveTo(x,y);
      sctx.lineTo(x+p.vx/1000*vScale, y+p.vy/1000*vScale);
      sctx.stroke();
    }
    // A vector (toward center)
    if(showA){
      const r=Math.hypot(p.x,p.y);
      sctx.strokeStyle="#34d399";
      sctx.beginPath(); sctx.moveTo(x,y);
      sctx.lineTo(x+(-p.x/r)*30, y+(-p.y/r)*30);
      sctx.stroke();
    }
  });

  // Readouts
  if(planets.length){
    const p=planets[0];
    const r=Math.hypot(p.x,p.y), v=Math.hypot(p.vx,p.vy);
    const k=kSpec(p)/1e6, u=uSpec(p)/1e6, e=k+u;
    $("rr").innerHTML=sciHTML(r/1000," km");
    $("rv").innerHTML=sciHTML(v/1000," km/s");
    $("rk").innerHTML=sciHTML(k," MJ/kg");
    $("ru").innerHTML=sciHTML(u," MJ/kg");
    $("re").innerHTML=sciHTML(e," MJ/kg");
    $("rtype").textContent= e<0?"æŸç¸›ï¼ˆæ©¢åœ“/åœ“ï¼‰":(Math.abs(e)<1e-3?"è‡¨ç•Œï¼ˆæ‹‹ç‰©ï¼‰":"é€ƒé€¸ï¼ˆé›™æ›²ï¼‰");
    pushE({k,u,e});
  }else{
    ["rr","rv","rk","ru","re","rtype"].forEach(id=>$(id).textContent="â€”");
  }
}

/* ---------- Loop ---------- */
function loop(){ step(); updateScale(); draw(); drawEnergy(); requestAnimationFrame(loop); }
(function init(){ updateAddButton(); loop(); })();
</script>
</body>
</html>
